# Installation
Prerequisites: Python 3

It is recommended to create a venv (virtual environment) first, to ensure everything is working.

# Initial setup
### Linux (Bash)
```bash
pip3 install -r requirements.txt
python3 install.py
nano settings.py
```
In settings.py, you should add your email credentials as indicated by default_settings.py. Additionally, you may change the other email settings if you use a SMTP provider other than Gmail. This email account will be used to send system emails, such as password reset emails.

### Windows (cmd)
```cmd
pip install -r requirements.txt
python install.py
```
Open settings.py in your text editor of choice, and you should add your email credentials as indicated by default_settings.py. Additionally, you may change the other email settings if you use a SMTP provider other than Gmail. This email account will be used to send system emails, such as password reset emails.

# Running in Debug Mode
### Linux (Bash)
```bash
export FLASK_APP=application.py
flask run
```

### Windows (cmd)
```cmd
set FLASK_APP=application.py
flask run
```
If you do not want to export the FLASK_APP variable every time you reset your terminal, you can create a symbolic link from app.py to application.py.

Do not expose the app to the web using debug mode. You should run the app through Nginx and Gunicorn or a similar service.

# Logging in for the first time
An admin account has been created in step 2. You can log in to it using the credentials `admin:FBLAadmin`. Make sure you change your password immediately after logging in. Enabling 2FA is also recommended for the admin account. You can change your password and enable 2FA through the settings page.

You are now good to go! It is recommended to start adding questions now, through the 'Admin Console' interface.
A minimum of 5 questions should be added, as that is the number of questions generated by the quiz.

## Optional: Using Nginx with Gunicorn on Ubuntu
If you are planning on running FBLAquiz through Nginx and Gunicorn on Ubuntu, this part of the guide will help you do that. You can also run FBLA using another WSGI program or Apache.
### Prerequisites
- An Ubuntu server/machine, preferably running a recent version (16.04 LTS or newer)
- Nginx installed
- A non-root user with sudo privileges
### Step 1 - Pre-setup
We should make sure that our system is up to date with Python.
```bash
sudo apt update
sudo apt install python3-pip python3-dev build-essential libssl-dev libffi-dev python3-setuptools python3-venv
```
Now that this is done, we can move on to the next step.
### Step 2 - Creating a Virtual Environment
Navigate to the path you would like to install FBLAquiz at. In the guide, we will use `/path/to/install`. Replace this with your path.
```bash
mkdir -p /path/to/install
cd /path/to/install
git clone https://github.com/jdabtieu/FBLA.git
cd FBLA
python3 -m venv .
source bin/activate
```
At this point, your terminal should change to something like this to indicate that you are in a virtual environment now: `(FBLA) user@machine:/path/to/install/FBLA$`.
### Step 3 - Configuring the Application
Run the following commands to install the dependencies.
```bash
pip install wheel
pip install gunicorn
pip install -r requirements.txt
```
Note that because you are in a virtual environment, you should use the `pip` command even if you have Python 3.

If you haven't already run the install script and editited settings.py earlier, now is a good time to do so.
```bash
python3 install.py
nano settings.py
```
You should be able to run the program in debug mode.
### Step 4 - Configuring Gunicorn
We need to tell Gunicorn to import our app.
```bash
echo 'from application import app' > wsgi.py
```
To test if everything has worked, you can run `gunicorn --bind 0.0.0.0:5000 wsgi:app` to see if it spits any errors. If there are no errors, you have set up everything properly.

Once there are no errors, we are done with the virtualenv, so we can deactivate it now.
```bash
deactivate
```

We'll now need to create a systemd service unit file.
```bash
sudo nano /etc/systemd/system/FBLAquiz.service
```
In this file, paste in the following content, remembering to replace `/path/to/install` and the user.
```
[Unit]
Description=Gunicorn instance to serve FBLAquiz
After=network.target

[Service]
User=YOUR USERNAME HERE
Group=www-data
WorkingDirectory=/path/to/install/FBLA
Environment="PATH=/path/to/install/FBLA/bin"
ExecStart=/path/to/install/FBLA/bin/gunicorn --workers 3 --bind unix:FBLAquiz.sock -m 007 wsgi:app

[Install]
WantedBy=multi-user.target
```
And then we can start the service.
```bash
sudo systemctl start FBLAquiz
sudo systemctl enable FBLAquiz
```
### Step 5 - Configuring Nginx
Now it's time to allow Nginx to communicate with Gunicorn.
```bash
sudo nano /etc/nginx/sites-available/FBLAquiz
```
In this file, paste in the following, making sure to replace `/path/to/install` and the domain.
```
server {
    listen 80;
    server_name DOMAIN www.DOMAIN;

    location / {
        include proxy_params;
        proxy_pass http://unix:/path/to/install/FBLA/FBLAquiz.sock;
    }
}
```
Finally, we can enable the config file, and check for syntax errors.
```bash
sudo ln -s /etc/nginx/sites-available/FBLAquiz /etc/nginx/sites-enabled
sudo nginx -t
```
If no issues are present, we can restart Nginx, and our web app should work now!
```bash
sudo systemctl restart nginx
```

If everything worked, you should be able to go to http://www.YOUR_DOMAIN and see the web app. If you get any errors, check the error logs. A common place for Nginx to store error logs is at `/var/log/nginx/error.log`.

A common error is 502 with permission denied in the error log, which you can fix by doing the following:

1. Run `namei -nom /path/to/install/FBLA/FBLAquiz.sock`.
2. Ensure that the www-data user can access every item on this path. This can be done by granting read and execute permissions to all users, or by setting the group to www-data and granting read and execute permissions to the group.
3. Restart Gunicorn and Nginx by running `sudo systemctl restart FBLAquiz; sudo systemctl restart nginx`.
