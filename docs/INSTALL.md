# Installation
Prerequisites: Python 3

This quide assumes that `python` is `python3`. If your Python installation points to python2, you should use `python3` instead of `python` for commands in this guide.

For updating instructions, click [here](#updating).

For specific instructions for Gunicorn + Nginx on Ubuntu, click [here](#installation-for-nginx--gunicorn-on-ubuntu).

# General Installation Instructions
It is strongly encouraged to use a virtualenv.

## Setting up the project
```bash
$ git clone --depth 1 https://github.com/jdabtieu/FBLA.git
$ cd FBLA/src
$ python -m venv .
```
Then, you should activate the virtualenv by running one of the following commands (depending on your platform):
```
. bin/activate (Linux)
Scripts\activate (Windows)
```

## Initial setup
```bash
$ pip install -r requirements.txt
$ python install.py
```
You should open settings.py in your favourite text editor (e.g. vim, nano, n++). In settings.py, you should add your email credentials as indicated. Additionally, you may change the other email settings if you use a SMTP provider other than Gmail. This email account will be used to send system emails, such as password reset emails.

## Running in Debug Mode
You can run the app in debug mode now, to ensure everything works. **Do not expose FBLAquiz to the web using debug mode.** You should run the app through a WSGI application, such as Gunicorn.
```bash
$ python application.py
```
If no errors occur after 10-15 seconds, you can hit `Ctrl+C` to shut it down.

## Logging in for the first time
An admin account has been created in the initial setup. You can log in to it using the credentials `admin:FBLAadmin`. Make sure you change the password immediately after logging in. Enabling 2FA is also recommended for the admin account. You can change your password and enable 2FA through the profile page.

You are now good to go! It is recommended to start adding questions now, through the 'Admin Console' interface.
A minimum of 5 questions must be added, as that is the number of questions generated by the quiz. It is also strongly recommended to add at least 5 questions to each problem category.

## Setting up backups
`daily_tasks.py` creates automatic backups of the database and splits logs by date. To set it up, use your task scheduler to run it once per day, in the src directory.
For example, for cron, you can use:
```cron
0 0 * * * cd /path/to/install/FBLA/src && python daily_tasks.py
```

## Allowing Google sign-in (optional)
By default, Google sign-in is disabled. However, if you are a G-suite for Workspace/Educatin user 
or otherwise would like Google sign-in functionality, it can be enabled through the following steps:

1. In settings.py, change `USE_GOOGLE_LOGIN` to `True` and `WEBSERVER_URL` to your server's URL.
Make sure you enter it with the schema ("https://" or "http://") and no trailing slashes. For 
example, "https://fblaquiz.live" is acceptable, while "fblaquiz.live" and "https://fblaquiz.live/" 
are not.
2. Go to https://console.cloud.google.com/apis/dashboard and create a new project called FBLAquiz.
3. Once created, go to the left-side navigation menu to find the "API & Services" entry, and click 
OAuth consent screen.
4. Fill in the required details on the first page and click Continue.
5. On the scopes page, add the auth/userinfo.email, auth/userinfo.profile, and openid scopes.
6. Continue to the end of the setup and ensure it is correct.
7. Go to the Credentials page and click Create Credentials, then OAuth client ID.
8. Select Web application, and add your server's URL + "/login/callback" to the authorized redirect 
URIs. For example, for a server at "https://fblaquiz.live/", enter "https://fblaquiz.live/login/callback".
9. Save the credential, and then click the download icon to save it to your computer.
10. Move the downloaded file to the server under the `FBLA/src` folder, and rename it to credentials.json.
11. Go back to the OAuth consent screen and click the Publish App button.
12. Follow the instructions to get published.

# Installation for Nginx + Gunicorn on Ubuntu
If you are planning on running FBLAquiz through Nginx and Gunicorn on Ubuntu, this part of the guide will help you do that. You can also run FBLA using another WSGI application or Apache.

## Prerequisites
- An Ubuntu server/machine, running a recent version (preferably 20.04 LTS)
- Nginx installed
- A non-root user with sudo privileges

## Step 1 - Pre-setup
We should make sure that our system is up to date.
```bash
$ sudo apt update && sudo apt upgrade
$ sudo apt install python3-pip python3-venv
```
Now that this is done, we can move on to the next step.

## Step 2 - Creating a Virtual Environment
Navigate to the path you would like to install FBLAquiz at. In the guide, we will use `/path/to/install`. Replace this with your path.
```bash
$ mkdir -p /path/to/install
$ cd /path/to/install
$ git clone --depth 1 https://github.com/jdabtieu/FBLA.git
$ cd FBLA/src
$ python -m venv .
$ . bin/activate
```
At this point, your terminal should change to something like this to indicate that you are in a virtual environment now: `(src) user@host:/path/to/install/FBLA/src$`.

## Step 3 - Configuring the Application
Run the following commands to install the dependencies.
```bash
$ pip install wheel
$ pip install gunicorn
$ pip install -r requirements.txt
```
Now, we should run the install script and change the configuration settings.
```bash
$ python install.py
$ nano settings.py
```
In settings.py, you should add your email credentials as indicated. Additionally, you may change the other email settings if you use a SMTP provider other than Gmail. This email account will be used to send system emails, such as password reset emails.

## Step 3.5 - Logging in for the first time
You should be able to run the program in debug mode using `python application.py` now. Try logging in to the admin account using the credentials `admin:FBLAadmin`. Make sure you change the password immediately after logging in. Enabling 2FA is also recommended for the admin account. You can change your password and enable 2FA through the profile page. If no errors occur, you can shut it down with `Ctrl+C` and continue to the next step.

## Step 4 - Configuring Gunicorn
We need to tell Gunicorn to import our app.
```bash
$ echo 'from application import app' > wsgi.py
```
To test if everything has worked, you can run `gunicorn --bind 0.0.0.0:5000 wsgi:app`. If no errors occur after 10-15 seconds, you can shut it down with `Ctrl+C`.

If there are no errors, we are done with the virtualenv, so we can deactivate it now.
```bash
$ deactivate
```

We'll now need to create a systemd service unit file.
```bash
$ sudo nano /etc/systemd/system/FBLAquiz.service
```
In this file, paste in the following content, remembering to replace `/path/to/install` and the user.
```ini
[Unit]
Description=Gunicorn instance to serve FBLAquiz
After=network.target

[Service]
User=YOUR USERNAME HERE
Group=www-data
WorkingDirectory=/path/to/install/FBLA/src
Environment="PATH=/path/to/install/FBLA/src/bin"
ExecStart=/path/to/install/FBLA/src/bin/gunicorn --workers 3 --bind unix:FBLAquiz.sock -m 007 wsgi:app

[Install]
WantedBy=multi-user.target
```
You may optionally change the number of workers, depending on the capabilities of the server. Once that's done, we can start the service.
```bash
$ sudo systemctl start FBLAquiz
$ sudo systemctl enable FBLAquiz
```
We can check to make sure everything works by running
```bash
$ sudo systemctl status FBLAquiz
```
If there are any errors, fix them.

## Step 5 - Configuring Nginx
Now it's time to allow Nginx to communicate with Gunicorn.
```bash
$ sudo nano /etc/nginx/sites-available/FBLAquiz
```
In this file, paste in the following, making sure to replace `/path/to/install` and the domain.
```nginx
server {
    listen 80;
    server_name YOUR_DOMAIN www.YOUR_DOMAIN;
    access_log /path/to/install/FBLA/src/logs/application.log;

    location / {
        include proxy_params;
        proxy_pass http://unix:/path/to/install/FBLA/src/FBLAquiz.sock;
    }
}
```
Finally, we can enable the config file, and check for syntax errors.
```bash
$ sudo ln -s /etc/nginx/sites-available/FBLAquiz /etc/nginx/sites-enabled
$ sudo nginx -t
```
If no issues are present, we can restart Nginx, and our web app should work now!
```bash
$ sudo systemctl restart nginx
```

If everything worked, you should be able to go to http://www.YOUR_DOMAIN and see the web app. If you get any errors, check the application logs and the error logs. A common place for Nginx to store error logs is at `/var/log/nginx/error.log`.

## Step 6 - Setting up backups
`daily_tasks.py` creates automatic backups of the database and splits logs by date. To set it up, use your task scheduler to run it once per day, in the src directory.
For example, for cron, you can use:
```cron
0 0 * * * cd /path/to/install/FBLA/src && python daily_tasks.py
```

## Step 7 (optional) - Setting up SSL
You can also set up SSL if you want, using certbot.

A very good guide is available [here](https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04) detailing this process.

## Step 8 (options) - Allowing Google sign-in
See [Allowing Google sign-in](#allowing-google-sign-in-optional)

## Common Errors
### 502 Bad Gateway on first install
1. Run `namei -nom /path/to/install/FBLA/src/FBLAquiz.sock`.
2. Ensure that the www-data group can access every item on this path. This can be done by granting read and execute permissions to all users, or by setting the group to www-data and granting read and execute permissions to the group.
3. Restart Gunicorn and Nginx by running `sudo systemctl restart FBLAquiz && sudo systemctl restart nginx`.

### 502 Bad Gateway after restart
1. Run `sudo chown USER /path/to/install/FBLA/src/logs/application.log` where USER is the user running FBLAquiz and /path/to/install is the installation path.
2. Restart Gunicorn by running `sudo systemctl restart FBLAquiz`.

### SMTPAuthenticationError
This is caused by invalid email credentials, or your email provider blocking access to less secure apps.
1. Ensure that the credentials in settings.py are correct.
2. Depending on the service you use, the option may be called something different. On Gmail, it's called "less secure access." Make sure this is enabled.
3. While signed into Gmail, go to the following link https://accounts.google.com/DisplayUnlockCaptcha and then trigger sending an email again (e.g. by requesting a password reset).
4. Google will sometimes turn off less secure access automatically if you haven't sent emails in a while. If this error appears out of nowhere, check the settings.

# Updating
To update, first fetch the newest version from GitHub. This can be done with
```bash
$ git pull
```

Then, to apply changes, run
```bash
$ sudo systemctl restart FBLAquiz
```
