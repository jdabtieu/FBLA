# Installation
Prerequisites: Python 3

For specific instructions for Gunicorn + Nginx on Ubuntu, scroll down to that section.

# General Installation Instructions
It is strongly encouraged to use a virtualenv.

## Setting up the project
```bash
$ git clone --depth 1 https://github.com/jdabtieu/FBLA.git
$ cd FBLA/src
$ python -m venv .
```
(On Windows, you may need to enter `python -m venv .` instead of using `python3`).
Then, you should activate the virtualenv by running one of the following commands (depending on your platform):
```
. bin/activate (Linux-based)
Scripts\activate (Windows)
```

## Initial setup
```bash
$ pip install -r requirements.txt
$ python install.py
```
You should open settings.py in your favourite text editor (e.g. vim, nano, n++). In settings.py, you should add your email credentials as indicated. Additionally, you may change the other email settings if you use a SMTP provider other than Gmail. This email account will be used to send system emails, such as password reset emails.

## Running in Debug Mode
You can run the app in debug mode now, to ensure everything works. Do not expose the app to the web using debug mode. You should run the app through a WSGI application.

### Linux (Bash)
```bash
$ export FLASK_APP=application.py
$ flask run
```

### Windows (cmd)
```cmd
> set FLASK_APP=application.py
> flask run
```
If you do not want to export the FLASK_APP variable every time you reset your terminal, you can create a symbolic link from app.py to application.py, or put it into your .bashrc.


## Logging in for the first time
An admin account has been created in the initial setup. You can log in to it using the credentials `admin:FBLAadmin`. Make sure you change the password immediately after logging in. Enabling 2FA is also recommended for the admin account. You can change your password and enable 2FA through the settings page.

You are now good to go! It is recommended to start adding questions now, through the 'Admin Console' interface.
A minimum of 5 questions should be added, as that is the number of questions generated by the quiz.

## Setting up backups
`daily_tasks.py` creates automatic backups of the database and splits logs by date. To set it up, use your task scheduler to run it once per day, in the src directory.
For example, for cron, you can use:
```cron
0 0 * * * cd /path/to/install/FBLA/src && python3 daily_tasks.py
```
If you prefer not to use python3 and instead use dot-slash, make sure daily_tasks.py is executable (`chmod +x daily_tasks.py`) and you can use:
```cron
0 0 * * * cd /path/to/install/FBLA/src && ./daily_tasks.py
```

# Installation for Nginx + Gunicorn on Ubuntu
If you are planning on running FBLAquiz through Nginx and Gunicorn on Ubuntu, this part of the guide will help you do that. You can also run FBLA using another WSGI application or Apache.

## Prerequisites
- An Ubuntu server/machine, running a recent version (preferably 20.04 LTS)
- Nginx installed
- A non-root user with sudo privileges

## Step 1 - Pre-setup
We should make sure that our system is up to date.
```bash
$ sudo apt update && sudo apt upgrade
$ sudo apt install python3-pip python3-venv
```
Now that this is done, we can move on to the next step.

## Step 2 - Creating a Virtual Environment
Navigate to the path you would like to install FBLAquiz at. In the guide, we will use `/path/to/install`. Replace this with your path.
```bash
$ mkdir -p /path/to/install
$ cd /path/to/install
$ git clone --depth 1 https://github.com/jdabtieu/FBLA.git
$ cd FBLA/src
$ python -m venv .
$ . bin/activate
```
At this point, your terminal should change to something like this to indicate that you are in a virtual environment now: `(src) user@host:/path/to/install/FBLA/src$`.

## Step 3 - Configuring the Application
Run the following commands to install the dependencies.
```bash
$ pip install wheel
$ pip install gunicorn
$ pip install -r requirements.txt
```
Note that because you are in a virtual environment, you should use the `pip` command even if you have Python 3.

Now, we should run the install script and change the configuration settings.
```bash
$ python install.py
$ nano settings.py
```
In settings.py, you should add your email credentials as indicated. Additionally, you may change the other email settings if you use a SMTP provider other than Gmail. This email account will be used to send system emails, such as password reset emails.

You should be able to run the program in debug mode now.

## Step 4 - Configuring Gunicorn
We need to tell Gunicorn to import our app.
```bash
$ echo 'from application import app' > wsgi.py
```
To test if everything has worked, you can run `gunicorn --bind 0.0.0.0:5000 wsgi:app` to see if it spits any errors. If there are no errors, you have set up everything properly.

Once there are no errors, we are done with the virtualenv, so we can deactivate it now.
```bash
$ deactivate
```

We'll now need to create a systemd service unit file.
```bash
$ sudo nano /etc/systemd/system/FBLAquiz.service
```
In this file, paste in the following content, remembering to replace `/path/to/install` and the user.
```
[Unit]
Description=Gunicorn instance to serve FBLAquiz
After=network.target

[Service]
User=YOUR USERNAME HERE
Group=www-data
WorkingDirectory=/path/to/install/FBLA/src
Environment="PATH=/path/to/install/FBLA/src/bin"
ExecStart=/path/to/install/FBLA/src/bin/gunicorn --workers 3 --bind unix:FBLAquiz.sock -m 007 wsgi:app

[Install]
WantedBy=multi-user.target
```
You may optionally change the number of workeres, depending on the speed of the server. Once that's done, we can start the service.
```bash
$ sudo systemctl start FBLAquiz
$ sudo systemctl enable FBLAquiz
```
We can check to make sure everything works by running
```bash
$ sudo systemctl status FBLAquiz
```
If there are any errors, fix them.

## Step 5 - Configuring Nginx
Now it's time to allow Nginx to communicate with Gunicorn.
```bash
$ sudo nano /etc/nginx/sites-available/FBLAquiz
```
In this file, paste in the following, making sure to replace `/path/to/install` and the domain.
```
server {
    listen 80;
    server_name YOUR_DOMAIN www.YOUR_DOMAIN;
    access_log /path/to/install/FBLA/src/logs/application.log;

    location / {
        include proxy_params;
        proxy_pass http://unix:/path/to/install/FBLA/src/FBLAquiz.sock;
    }
}
```
Finally, we can enable the config file, and check for syntax errors.
```bash
$ sudo ln -s /etc/nginx/sites-available/FBLAquiz /etc/nginx/sites-enabled
$ sudo nginx -t
```
If no issues are present, we can restart Nginx, and our web app should work now!
```bash
$ sudo systemctl restart nginx
```

If everything worked, you should be able to go to http://www.YOUR_DOMAIN and see the web app. If you get any errors, check the application logs and the error logs. A common place for Nginx to store error logs is at `/var/log/nginx/error.log`.

## Step 6 - Setting up backups
`daily_tasks.py` creates automatic backups of the database and splits logs by date. To set it up, use your task scheduler to run it once per day, in the src directory.
For example, for cron, you can use:
```cron
0 0 * * * cd /path/to/install/FBLA/src && python3 daily_tasks.py
```
If you prefer not to use python3 and instead use dot-slash, make sure daily_tasks.py is executable (`chmod +x daily_tasks.py`) and you can use:
```cron
0 0 * * * cd /path/to/install/FBLA/src && ./daily_tasks.py
```

## Step 7 (optional) - Setting up SSL
You can also set up SSL if you want, using certbot.

A very good guide is available at https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04 detailing this process.

## Common Errors
### 502 Bad Gateway on first install
1. Run `namei -nom /path/to/install/FBLA/src/FBLAquiz.sock`.
2. Ensure that the www-data group can access every item on this path. This can be done by granting read and execute permissions to all users, or by setting the group to www-data and granting read and execute permissions to the group.
3. Restart Gunicorn and Nginx by running `sudo systemctl restart FBLAquiz && sudo systemctl restart nginx`.

### 502 Bad Gateway after restart
1. Run `sudo chown USER /path/to/install/FBLA/src/logs/application.log` where USER is the user running FBLAquiz and /path/to/install is the installation path.
2. Restart Gunicorn by running `sudo systemctl restart FBLAquiz`.

### SMTPAuthenticationError
This is caused by invalid email credentials, or your email provider blocking access to less secure apps.
1. Ensure that the credentials in settings.py are correct.
2. Depending on the service you use, the option may be called something different. On Gmail, it's called "less secure access." Make sure this is enabled.
3. While signed into Gmail, go to the following link https://accounts.google.com/DisplayUnlockCaptcha and then trigger sending an email again (e.g. by requesting a password reset).
4. Google will sometimes turn off less secure access automatically if you haven't sent emails in a while. If this error appears out of nowhere, check the settings.
